(()=>{"use strict";var __webpack_modules__={3413:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.AppController=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481);let AppController=class AppController{};AppController=tslib_1.__decorate([(0,common_1.Controller)()],AppController),exports.AppController=AppController},3029:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.AppModule=exports.Public=exports.IS_PUBLIC_KEY=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481);exports.IS_PUBLIC_KEY="isPublic";exports.Public=()=>(0,common_1.SetMetadata)(exports.IS_PUBLIC_KEY,!0);const common_2=__webpack_require__(6481),mongoose_1=__webpack_require__(1794),auth_module_1=__webpack_require__(6391),app_controller_1=__webpack_require__(3413),app_service_1=__webpack_require__(8955),communities_module_1=__webpack_require__(5467),threads_module_1=__webpack_require__(6893),users_module_1=__webpack_require__(9568),core_1=__webpack_require__(143),jwt_auth_guard_1=__webpack_require__(8801),roles_guard_1=__webpack_require__(1088),themes_module_1=__webpack_require__(4894),messages_module_1=__webpack_require__(8543),neo4j_module_1=__webpack_require__(8558),environment_1=__webpack_require__(5070);let AppModule=class AppModule{};AppModule=tslib_1.__decorate([(0,common_2.Module)({imports:[mongoose_1.MongooseModule.forRoot(environment_1.environment.BASE_MONGO_URL),communities_module_1.CommunitiesModule,threads_module_1.ThreadsModule,auth_module_1.AuthModule,users_module_1.UsersModule,themes_module_1.ThemesModule,messages_module_1.MessagesModule,neo4j_module_1.Neo4jModule.forRoot({scheme:"bolt",host:environment_1.environment.BASE_NEO_HOST,port:7687,username:environment_1.environment.USERNAME_NEO,password:environment_1.environment.PASSWORD_NEO})],controllers:[app_controller_1.AppController],providers:[{provide:core_1.APP_GUARD,useClass:jwt_auth_guard_1.JwtAuthGuard},{provide:core_1.APP_GUARD,useClass:roles_guard_1.RolesGuard},app_service_1.AppService]})],AppModule),exports.AppModule=AppModule},8955:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.AppService=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481);let AppService=class AppService{getData(){return{message:"Welcome to gessit-api!"}}};AppService=tslib_1.__decorate([(0,common_1.Injectable)()],AppService),exports.AppService=AppService},9705:(__unused_webpack_module,exports,__webpack_require__)=>{var _a,_b;Object.defineProperty(exports,"__esModule",{value:!0}),exports.AuthController=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),app_module_1=__webpack_require__(3029),auth_service_1=__webpack_require__(1e3),local_auth_guard_1=__webpack_require__(4238),create_user_dto_1=__webpack_require__(4837);let AuthController=class AuthController{constructor(authService){this.authService=authService}login(req){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return this.authService.login(req.body)}))}register(user){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return this.authService.register(user)}))}getProfile(req){return req.user}};tslib_1.__decorate([(0,app_module_1.Public)(),(0,common_1.UseGuards)(local_auth_guard_1.LocalAuthGuard),(0,common_1.Post)("login"),tslib_1.__param(0,(0,common_1.Request)()),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object]),tslib_1.__metadata("design:returntype",Promise)],AuthController.prototype,"login",null),tslib_1.__decorate([(0,app_module_1.Public)(),(0,common_1.Post)("register"),tslib_1.__param(0,(0,common_1.Body)()),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",["function"==typeof(_b=void 0!==create_user_dto_1.CreateUserDto&&create_user_dto_1.CreateUserDto)?_b:Object]),tslib_1.__metadata("design:returntype",Promise)],AuthController.prototype,"register",null),tslib_1.__decorate([(0,common_1.Get)("profile"),tslib_1.__param(0,(0,common_1.Request)()),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object]),tslib_1.__metadata("design:returntype",void 0)],AuthController.prototype,"getProfile",null),AuthController=tslib_1.__decorate([(0,common_1.Controller)("auth"),tslib_1.__metadata("design:paramtypes",["function"==typeof(_a=void 0!==auth_service_1.AuthService&&auth_service_1.AuthService)?_a:Object])],AuthController),exports.AuthController=AuthController},6391:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.AuthModule=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),auth_service_1=__webpack_require__(1e3),local_strategy_1=__webpack_require__(9309),jwt_strategy_1=__webpack_require__(9483),users_module_1=__webpack_require__(9568),passport_1=__webpack_require__(4340),jwt_1=__webpack_require__(2064),constant_1=__webpack_require__(7049),auth_controller_1=__webpack_require__(9705);let AuthModule=class AuthModule{};AuthModule=tslib_1.__decorate([(0,common_1.Module)({imports:[users_module_1.UsersModule,passport_1.PassportModule,jwt_1.JwtModule.register({secret:constant_1.jwtConstants.secret,signOptions:{expiresIn:"2d"}})],providers:[auth_service_1.AuthService,local_strategy_1.LocalStrategy,jwt_strategy_1.JwtStrategy],exports:[auth_service_1.AuthService],controllers:[auth_controller_1.AuthController]})],AuthModule),exports.AuthModule=AuthModule},1e3:(__unused_webpack_module,exports,__webpack_require__)=>{var _a,_b;Object.defineProperty(exports,"__esModule",{value:!0}),exports.AuthService=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),users_service_1=__webpack_require__(8223),jwt_1=__webpack_require__(2064),bcrypt=__webpack_require__(7096);let AuthService=class AuthService{constructor(usersService,jwtService){this.usersService=usersService,this.jwtService=jwtService}validateUser(username,pass){return tslib_1.__awaiter(this,void 0,void 0,(function*(){const user=yield this.usersService.getUserByUsername(username);if(user){if(yield bcrypt.compare(pass,user.password)){const{password}=user;return tslib_1.__rest(user,["password"])}}throw new common_1.HttpException("Incorrect password or emailaddress",common_1.HttpStatus.BAD_REQUEST)}))}login(user){return tslib_1.__awaiter(this,void 0,void 0,(function*(){const payload={id:user._id,username:user.username,roles:user.roles},loggedInUser=yield this.usersService.getUserByUsername(user.username);return{_id:loggedInUser._id,username:loggedInUser.username,emailAddress:loggedInUser.emailAddress,roles:loggedInUser.roles,image:loggedInUser.image,access_token:this.jwtService.sign(payload)}}))}register(user){return tslib_1.__awaiter(this,void 0,void 0,(function*(){const result=yield this.usersService.createUser(user.username,user.birthDate,user.emailAddress,user.phoneNumber,user.password,user.image);return yield this.login(result)}))}};AuthService=tslib_1.__decorate([(0,common_1.Injectable)(),tslib_1.__metadata("design:paramtypes",["function"==typeof(_a=void 0!==users_service_1.UsersService&&users_service_1.UsersService)?_a:Object,"function"==typeof(_b=void 0!==jwt_1.JwtService&&jwt_1.JwtService)?_b:Object])],AuthService),exports.AuthService=AuthService},7049:(__unused_webpack_module,exports)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.jwtConstants=void 0,exports.jwtConstants={secret:"secretKey"}},8801:(__unused_webpack_module,exports,__webpack_require__)=>{var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.JwtAuthGuard=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),core_1=__webpack_require__(143),passport_1=__webpack_require__(4340),app_module_1=__webpack_require__(3029);let JwtAuthGuard=class JwtAuthGuard extends((0,passport_1.AuthGuard)("jwt")){constructor(reflector){super(),this.reflector=reflector}canActivate(context){return!!this.reflector.getAllAndOverride(app_module_1.IS_PUBLIC_KEY,[context.getHandler(),context.getClass()])||super.canActivate(context)}};JwtAuthGuard=tslib_1.__decorate([(0,common_1.Injectable)(),tslib_1.__metadata("design:paramtypes",["function"==typeof(_a=void 0!==core_1.Reflector&&core_1.Reflector)?_a:Object])],JwtAuthGuard),exports.JwtAuthGuard=JwtAuthGuard},9483:(__unused_webpack_module,exports,__webpack_require__)=>{var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.JwtStrategy=void 0;const tslib_1=__webpack_require__(752),passport_jwt_1=__webpack_require__(136),passport_1=__webpack_require__(4340),common_1=__webpack_require__(6481),constant_1=__webpack_require__(7049),users_service_1=__webpack_require__(8223);let JwtStrategy=class JwtStrategy extends((0,passport_1.PassportStrategy)(passport_jwt_1.Strategy)){constructor(usersService){super({jwtFromRequest:passport_jwt_1.ExtractJwt.fromAuthHeaderAsBearerToken(),ignoreExpiration:!1,secretOrKey:constant_1.jwtConstants.secret}),this.usersService=usersService}validate(payload){return tslib_1.__awaiter(this,void 0,void 0,(function*(){const user=yield this.usersService.getUserByUsername(payload.username);if(user)return{id:user._id,username:user.username,roles:user.roles};throw new common_1.HttpException("Login has expired",common_1.HttpStatus.UNAUTHORIZED)}))}};JwtStrategy=tslib_1.__decorate([(0,common_1.Injectable)(),tslib_1.__metadata("design:paramtypes",["function"==typeof(_a=void 0!==users_service_1.UsersService&&users_service_1.UsersService)?_a:Object])],JwtStrategy),exports.JwtStrategy=JwtStrategy},4238:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.LocalAuthGuard=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),passport_1=__webpack_require__(4340);let LocalAuthGuard=class LocalAuthGuard extends((0,passport_1.AuthGuard)("local")){};LocalAuthGuard=tslib_1.__decorate([(0,common_1.Injectable)()],LocalAuthGuard),exports.LocalAuthGuard=LocalAuthGuard},9309:(__unused_webpack_module,exports,__webpack_require__)=>{var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.LocalStrategy=void 0;const tslib_1=__webpack_require__(752),passport_local_1=__webpack_require__(7055),passport_1=__webpack_require__(4340),common_1=__webpack_require__(6481),auth_service_1=__webpack_require__(1e3);let LocalStrategy=class LocalStrategy extends((0,passport_1.PassportStrategy)(passport_local_1.Strategy)){constructor(authService){super(),this.authService=authService}validate(username,password){return tslib_1.__awaiter(this,void 0,void 0,(function*(){const user=yield this.authService.validateUser(username,password);if(!user)throw new common_1.UnauthorizedException;return user}))}};LocalStrategy=tslib_1.__decorate([(0,common_1.Injectable)(),tslib_1.__metadata("design:paramtypes",["function"==typeof(_a=void 0!==auth_service_1.AuthService&&auth_service_1.AuthService)?_a:Object])],LocalStrategy),exports.LocalStrategy=LocalStrategy},8851:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.Roles=exports.ROLES_KEY=void 0;const common_1=__webpack_require__(6481);exports.ROLES_KEY="roles";exports.Roles=(...roles)=>(0,common_1.SetMetadata)(exports.ROLES_KEY,roles)},1088:(__unused_webpack_module,exports,__webpack_require__)=>{var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.RolesGuard=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),core_1=__webpack_require__(143),roles_decorator_1=__webpack_require__(8851);let RolesGuard=class RolesGuard{constructor(reflector){this.reflector=reflector}canActivate(context){const requiredRoles=this.reflector.getAllAndOverride(roles_decorator_1.ROLES_KEY,[context.getHandler(),context.getClass()]);if(!requiredRoles)return!0;const{user}=context.switchToHttp().getRequest();return requiredRoles.some((role=>{var _a;return null===(_a=user.roles)||void 0===_a?void 0:_a.includes(role)}))}};RolesGuard=tslib_1.__decorate([(0,common_1.Injectable)(),tslib_1.__metadata("design:paramtypes",["function"==typeof(_a=void 0!==core_1.Reflector&&core_1.Reflector)?_a:Object])],RolesGuard),exports.RolesGuard=RolesGuard},152:(__unused_webpack_module,exports,__webpack_require__)=>{var _a,_b,_c,_d,_e,_f,_g,_h,_j,_k,_l,_m;Object.defineProperty(exports,"__esModule",{value:!0}),exports.CommunitiesController=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),communities_service_1=__webpack_require__(8345),create_community_dto_1=__webpack_require__(6622),update_community_dto_1=__webpack_require__(9785),object_id_pipe_1=__webpack_require__(3358),app_module_1=__webpack_require__(3029);let CommunitiesController=class CommunitiesController{constructor(communityService){this.communityService=communityService}getAllJoinedCommunities(req){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.communityService.getJoinedCommunities(req)}))}getAllCreatedCommunities(req){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.communityService.getCreatedCommunities(req)}))}getCommunities(){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.communityService.getCommunities()}))}getCommunityById(id){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.communityService.getCommunityById(id)}))}createCommunity(req,createCommunityDto){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.communityService.createCommunity(req,createCommunityDto)}))}joinCommunity(req,id){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.communityService.joinCommunity(req,id)}))}leaveCommunity(req,id){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.communityService.leaveCommunity(req,id)}))}updateCommunity(req,id,updateCommunityDto){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.communityService.updateCommunity(req,id,updateCommunityDto)}))}deleteCommunity(req,id){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.communityService.deleteCommunity(req,id)}))}};tslib_1.__decorate([(0,common_1.Get)("/joined"),tslib_1.__param(0,(0,common_1.Req)()),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object]),tslib_1.__metadata("design:returntype","function"==typeof(_b="undefined"!=typeof Promise&&Promise)?_b:Object)],CommunitiesController.prototype,"getAllJoinedCommunities",null),tslib_1.__decorate([(0,common_1.Get)("/created"),tslib_1.__param(0,(0,common_1.Req)()),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object]),tslib_1.__metadata("design:returntype","function"==typeof(_c="undefined"!=typeof Promise&&Promise)?_c:Object)],CommunitiesController.prototype,"getAllCreatedCommunities",null),tslib_1.__decorate([(0,app_module_1.Public)(),(0,common_1.Get)(),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[]),tslib_1.__metadata("design:returntype","function"==typeof(_d="undefined"!=typeof Promise&&Promise)?_d:Object)],CommunitiesController.prototype,"getCommunities",null),tslib_1.__decorate([(0,app_module_1.Public)(),(0,common_1.Get)(":id"),tslib_1.__param(0,(0,common_1.Param)("id",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[String]),tslib_1.__metadata("design:returntype","function"==typeof(_e="undefined"!=typeof Promise&&Promise)?_e:Object)],CommunitiesController.prototype,"getCommunityById",null),tslib_1.__decorate([(0,common_1.Post)(),tslib_1.__param(0,(0,common_1.Req)()),tslib_1.__param(1,(0,common_1.Body)()),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object,"function"==typeof(_f=void 0!==create_community_dto_1.CreateCommunityDto&&create_community_dto_1.CreateCommunityDto)?_f:Object]),tslib_1.__metadata("design:returntype","function"==typeof(_g="undefined"!=typeof Promise&&Promise)?_g:Object)],CommunitiesController.prototype,"createCommunity",null),tslib_1.__decorate([(0,common_1.Post)(":id/join"),tslib_1.__param(0,(0,common_1.Req)()),tslib_1.__param(1,(0,common_1.Param)("id",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object,String]),tslib_1.__metadata("design:returntype","function"==typeof(_h="undefined"!=typeof Promise&&Promise)?_h:Object)],CommunitiesController.prototype,"joinCommunity",null),tslib_1.__decorate([(0,common_1.Post)(":id/leave"),tslib_1.__param(0,(0,common_1.Req)()),tslib_1.__param(1,(0,common_1.Param)("id",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object,String]),tslib_1.__metadata("design:returntype","function"==typeof(_j="undefined"!=typeof Promise&&Promise)?_j:Object)],CommunitiesController.prototype,"leaveCommunity",null),tslib_1.__decorate([(0,common_1.Patch)(":id"),tslib_1.__param(0,(0,common_1.Req)()),tslib_1.__param(1,(0,common_1.Param)("id",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(2,(0,common_1.Body)()),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object,String,"function"==typeof(_k=void 0!==update_community_dto_1.UpdateCommunityDto&&update_community_dto_1.UpdateCommunityDto)?_k:Object]),tslib_1.__metadata("design:returntype","function"==typeof(_l="undefined"!=typeof Promise&&Promise)?_l:Object)],CommunitiesController.prototype,"updateCommunity",null),tslib_1.__decorate([(0,common_1.Delete)(":id"),tslib_1.__param(0,(0,common_1.Req)()),tslib_1.__param(1,(0,common_1.Param)("id",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object,String]),tslib_1.__metadata("design:returntype","function"==typeof(_m="undefined"!=typeof Promise&&Promise)?_m:Object)],CommunitiesController.prototype,"deleteCommunity",null),CommunitiesController=tslib_1.__decorate([(0,common_1.Controller)("community"),tslib_1.__metadata("design:paramtypes",["function"==typeof(_a=void 0!==communities_service_1.CommunitiesService&&communities_service_1.CommunitiesService)?_a:Object])],CommunitiesController),exports.CommunitiesController=CommunitiesController},5467:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.CommunitiesModule=void 0;const tslib_1=__webpack_require__(752),mongoose_1=__webpack_require__(1794),common_1=__webpack_require__(6481),community_schema_1=__webpack_require__(5811),communities_controller_1=__webpack_require__(152),communities_service_1=__webpack_require__(8345),themes_module_1=__webpack_require__(4894),users_module_1=__webpack_require__(9568);let CommunitiesModule=class CommunitiesModule{};CommunitiesModule=tslib_1.__decorate([(0,common_1.Module)({imports:[mongoose_1.MongooseModule.forFeature([{name:community_schema_1.Community.name,schema:community_schema_1.CommunitySchema}]),themes_module_1.ThemesModule,(0,common_1.forwardRef)((()=>users_module_1.UsersModule))],controllers:[communities_controller_1.CommunitiesController],providers:[communities_service_1.CommunitiesService],exports:[mongoose_1.MongooseModule,communities_service_1.CommunitiesService]})],CommunitiesModule),exports.CommunitiesModule=CommunitiesModule},8345:(__unused_webpack_module,exports,__webpack_require__)=>{var _a,_b,_c;Object.defineProperty(exports,"__esModule",{value:!0}),exports.CommunitiesService=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),community_schema_1=__webpack_require__(5811),mongoose_1=__webpack_require__(1185),themes_service_1=__webpack_require__(9493),users_service_1=__webpack_require__(8223),mongoose_2=__webpack_require__(1794),object_id_pipe_1=__webpack_require__(3358),role_enum_1=__webpack_require__(4302);let CommunitiesService=class CommunitiesService{constructor(communityModel,themesService,usersService){this.communityModel=communityModel,this.themesService=themesService,this.usersService=usersService}getCommunityById(id){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.existing(id),yield this.communityModel.findOne({_id:new mongoose_1.Types.ObjectId(id)})}))}getCommunities(){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.communityModel.find({})}))}getJoinedCommunities(req){var e_1,_a;return tslib_1.__awaiter(this,void 0,void 0,(function*(){const joinedCommunities=[],user=yield this.usersService.getUserById(req.user.id);try{for(var _c,_b=tslib_1.__asyncValues(user.joinedCommunities);!(_c=yield _b.next()).done;){const communityId=_c.value;joinedCommunities.push(yield this.getCommunityById(communityId.toString()))}}catch(e_1_1){e_1={error:e_1_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&(yield _a.call(_b))}finally{if(e_1)throw e_1.error}}return joinedCommunities}))}getCreatedCommunities(req){var e_2,_a;return tslib_1.__awaiter(this,void 0,void 0,(function*(){const createdCommunities=[],user=yield this.usersService.getUserById(req.user.id);try{for(var _c,_b=tslib_1.__asyncValues(user.createdCommunities);!(_c=yield _b.next()).done;){const communityId=_c.value;createdCommunities.push(yield this.getCommunityById(communityId.toString()))}}catch(e_2_1){e_2={error:e_2_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&(yield _a.call(_b))}finally{if(e_2)throw e_2.error}}return createdCommunities}))}createCommunity(req,createCommunityDto){return tslib_1.__awaiter(this,void 0,void 0,(function*(){if(createCommunityDto.themes&&!(yield this.areValidObjectIds(createCommunityDto.themes)))throw new common_1.HttpException("Themes attribute data must be of type ObjectId!",common_1.HttpStatus.BAD_REQUEST);const themesArray=(yield this.themesService.getThemes()).filter((p=>createCommunityDto.themes.includes(p._id.toString()))),mergedCommunity=new this.communityModel(Object.assign(Object.assign({},createCommunityDto),{_id:new mongoose_1.Types.ObjectId,creationDate:new Date,ranking:0,themes:themesArray,owner:yield this.usersService.getUserById(req.user.id)}));yield this.usersService.addCreatedCommunity(mergedCommunity._id,new mongoose_1.Types.ObjectId(req.user.id));const community=yield this.communityModel.create(mergedCommunity);return yield this.communityModel.updateMany({_id:mergedCommunity._id,"owner._id":new mongoose_1.Types.ObjectId(req.user.id)},{$push:{"owner.$[_id]createdCommunities":mergedCommunity._id}}),community}))}joinCommunity(req,id){return tslib_1.__awaiter(this,void 0,void 0,(function*(){if(yield this.existing(id),(yield this.getCommunityById(id)).owner._id.equals(req.user.id))throw new common_1.HttpException("Can not join your own created community!",common_1.HttpStatus.BAD_REQUEST);if((yield this.getCommunityById(id)).members.filter((p=>p._id.equals(req.user.id))).length>0)throw new common_1.HttpException("Already part of this community!",common_1.HttpStatus.BAD_REQUEST);yield this.usersService.addJoinedCommunity(new mongoose_1.Types.ObjectId(id),new mongoose_1.Types.ObjectId(req.user.id));const community=yield this.communityModel.findOneAndUpdate({_id:new mongoose_1.Types.ObjectId(id)},{$push:{members:(yield this.usersService.getUserById(req.user.id))._id}});return yield this.communityModel.updateMany({_id:new mongoose_1.Types.ObjectId(id),"owner._id":new mongoose_1.Types.ObjectId(req.user.id)},{$push:{"owner.$[_id]joinedCommunities":new mongoose_1.Types.ObjectId(id)}}),community}))}leaveCommunity(req,id){return tslib_1.__awaiter(this,void 0,void 0,(function*(){if(yield this.existing(id),(yield this.getCommunityById(id)).owner._id.equals(req.user.id))throw new common_1.HttpException("Can not leave your own created community!",common_1.HttpStatus.BAD_REQUEST);if(0===(yield this.getCommunityById(id)).members.filter((p=>p._id.equals(req.user.id))).length)throw new common_1.HttpException("Not part of this community!",common_1.HttpStatus.BAD_REQUEST);yield this.usersService.removeJoinedCommunity(new mongoose_1.Types.ObjectId(id),new mongoose_1.Types.ObjectId(req.user.id));const community=yield this.communityModel.findOneAndUpdate({_id:new mongoose_1.Types.ObjectId(id)},{$pull:{members:(yield this.usersService.getUserById(req.user.id))._id}});return yield this.communityModel.updateMany({_id:new mongoose_1.Types.ObjectId(id),"owner._id":new mongoose_1.Types.ObjectId(req.user.id)},{$pull:{"owner.$[_id]joinedCommunities":new mongoose_1.Types.ObjectId(id)}}),community}))}updateCommunity(req,id,updateCommunityDto){return tslib_1.__awaiter(this,void 0,void 0,(function*(){if(updateCommunityDto.themes&&!(yield this.areValidObjectIds(updateCommunityDto.themes)))throw new common_1.HttpException("Themes attribute data must be of type ObjectId!",common_1.HttpStatus.BAD_REQUEST);if(yield this.existing(id),(yield this.getCommunityById(id)).owner._id.equals(req.user.id)||req.user.roles.includes(role_enum_1.Role.Admin)){let updatedObject={};if(updateCommunityDto.themes){const themes=[];for(const theme of updateCommunityDto.themes)themes.push(yield this.themesService.getThemeById(theme));delete updateCommunityDto.themes,updatedObject={themes}}return updatedObject=Object.assign(Object.assign({},updateCommunityDto),updatedObject),yield this.communityModel.findOneAndUpdate({_id:new mongoose_1.Types.ObjectId(id)},updatedObject)}throw new common_1.HttpException("Unauthorized",common_1.HttpStatus.UNAUTHORIZED)}))}deleteCommunity(req,id){var e_3,_a;return tslib_1.__awaiter(this,void 0,void 0,(function*(){yield this.existing(id);const community=yield this.communityModel.findOne({_id:new mongoose_1.Types.ObjectId(id)}),creator=yield this.usersService.getUserById(community.owner._id.toString());if((yield this.getCommunityById(id)).owner._id.equals(req.user.id)||req.user.roles.includes(role_enum_1.Role.Admin)){try{for(var _c,_b=tslib_1.__asyncValues(community.members);!(_c=yield _b.next()).done;){const memberId=_c.value;yield this.usersService.removeJoinedCommunity(new mongoose_1.Types.ObjectId(community._id),new mongoose_1.Types.ObjectId(memberId))}}catch(e_3_1){e_3={error:e_3_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&(yield _a.call(_b))}finally{if(e_3)throw e_3.error}}return yield this.usersService.removeCreatedCommunity(new mongoose_1.Types.ObjectId(id),new mongoose_1.Types.ObjectId(creator._id)),yield this.communityModel.findOneAndDelete({_id:new mongoose_1.Types.ObjectId(id)})}throw new common_1.HttpException("Unauthorized",common_1.HttpStatus.UNAUTHORIZED)}))}areValidObjectIds(value){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return value.every((id=>object_id_pipe_1.ObjectIdPipe.isValidObjectId(id)))}))}existing(communityId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){if(!(yield this.communityModel.findOne({_id:new mongoose_1.Types.ObjectId(communityId)})))throw new common_1.HttpException(`Community with id ${communityId} does not exist!`,common_1.HttpStatus.BAD_REQUEST)}))}};CommunitiesService=tslib_1.__decorate([(0,common_1.Injectable)(),tslib_1.__param(0,(0,mongoose_2.InjectModel)(community_schema_1.Community.name)),tslib_1.__param(2,(0,common_1.Inject)((0,common_1.forwardRef)((()=>users_service_1.UsersService)))),tslib_1.__metadata("design:paramtypes",["function"==typeof(_a=void 0!==mongoose_1.Model&&mongoose_1.Model)?_a:Object,"function"==typeof(_b=void 0!==themes_service_1.ThemesService&&themes_service_1.ThemesService)?_b:Object,"function"==typeof(_c=void 0!==users_service_1.UsersService&&users_service_1.UsersService)?_c:Object])],CommunitiesService),exports.CommunitiesService=CommunitiesService},5811:(__unused_webpack_module,exports,__webpack_require__)=>{var _a,_b,_c,_d;Object.defineProperty(exports,"__esModule",{value:!0}),exports.CommunitySchema=exports.Community=void 0;const tslib_1=__webpack_require__(752),mongoose_1=__webpack_require__(1794),mongoose_2=__webpack_require__(1185),user_schema_1=__webpack_require__(8366);let Community=class Community{};tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type","function"==typeof(_a=void 0!==mongoose_2.Types&&mongoose_2.Types.ObjectId)?_a:Object)],Community.prototype,"_id",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type",String)],Community.prototype,"name",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type",String)],Community.prototype,"description",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type","function"==typeof(_b="undefined"!=typeof Number&&Number)?_b:Object)],Community.prototype,"ranking",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type","function"==typeof(_c="undefined"!=typeof Date&&Date)?_c:Object)],Community.prototype,"creationDate",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type",String)],Community.prototype,"image",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type",Boolean)],Community.prototype,"isOpen",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)({default:[]}),tslib_1.__metadata("design:type",Array)],Community.prototype,"themes",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)({default:[]}),tslib_1.__metadata("design:type",Array)],Community.prototype,"threads",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)({default:[],ref:"User"}),tslib_1.__metadata("design:type",Array)],Community.prototype,"members",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type","function"==typeof(_d=void 0!==user_schema_1.User&&user_schema_1.User)?_d:Object)],Community.prototype,"owner",void 0),Community=tslib_1.__decorate([(0,mongoose_1.Schema)()],Community),exports.Community=Community,exports.CommunitySchema=mongoose_1.SchemaFactory.createForClass(Community)},6622:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.CreateCommunityDto=void 0;const tslib_1=__webpack_require__(752),class_validator_1=__webpack_require__(5849);class CreateCommunityDto{}tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsNotEmpty)(),(0,class_validator_1.IsDefined)(),tslib_1.__metadata("design:type",String)],CreateCommunityDto.prototype,"name",void 0),tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsNotEmpty)(),(0,class_validator_1.IsDefined)(),tslib_1.__metadata("design:type",String)],CreateCommunityDto.prototype,"description",void 0),tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsNotEmpty)(),(0,class_validator_1.IsDefined)(),tslib_1.__metadata("design:type",String)],CreateCommunityDto.prototype,"image",void 0),tslib_1.__decorate([(0,class_validator_1.IsBoolean)(),(0,class_validator_1.IsNotEmpty)(),(0,class_validator_1.IsDefined)(),tslib_1.__metadata("design:type",Boolean)],CreateCommunityDto.prototype,"isOpen",void 0),tslib_1.__decorate([(0,class_validator_1.IsNotEmpty)(),(0,class_validator_1.IsDefined)(),tslib_1.__metadata("design:type",Array)],CreateCommunityDto.prototype,"themes",void 0),exports.CreateCommunityDto=CreateCommunityDto},9785:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.UpdateCommunityDto=void 0;const tslib_1=__webpack_require__(752),class_validator_1=__webpack_require__(5849);class UpdateCommunityDto{}tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsOptional)(),tslib_1.__metadata("design:type",String)],UpdateCommunityDto.prototype,"name",void 0),tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsOptional)(),tslib_1.__metadata("design:type",String)],UpdateCommunityDto.prototype,"description",void 0),tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsOptional)(),tslib_1.__metadata("design:type",String)],UpdateCommunityDto.prototype,"image",void 0),tslib_1.__decorate([(0,class_validator_1.IsBoolean)(),(0,class_validator_1.IsOptional)(),tslib_1.__metadata("design:type",Boolean)],UpdateCommunityDto.prototype,"isOpen",void 0),tslib_1.__decorate([(0,class_validator_1.IsOptional)(),tslib_1.__metadata("design:type",Array)],UpdateCommunityDto.prototype,"themes",void 0),tslib_1.__decorate([(0,class_validator_1.IsOptional)(),tslib_1.__metadata("design:type",Array)],UpdateCommunityDto.prototype,"threads",void 0),exports.UpdateCommunityDto=UpdateCommunityDto},7213:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.CreateMessageDto=void 0;const tslib_1=__webpack_require__(752),class_validator_1=__webpack_require__(5849);class CreateMessageDto{}tslib_1.__decorate([(0,class_validator_1.IsString)(),tslib_1.__metadata("design:type",String)],CreateMessageDto.prototype,"content",void 0),exports.CreateMessageDto=CreateMessageDto},2829:(__unused_webpack_module,exports,__webpack_require__)=>{var _a,_b,_c;Object.defineProperty(exports,"__esModule",{value:!0}),exports.MessageSchema=exports.Message=void 0;const tslib_1=__webpack_require__(752),mongoose_1=__webpack_require__(1794),mongoose_2=__webpack_require__(1185);let Message=class Message{};tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type","function"==typeof(_a=void 0!==mongoose_2.Types&&mongoose_2.Types.ObjectId)?_a:Object)],Message.prototype,"_id",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)({ref:"User"}),tslib_1.__metadata("design:type","function"==typeof(_b=void 0!==mongoose_2.Types&&mongoose_2.Types.ObjectId)?_b:Object)],Message.prototype,"creator",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type",String)],Message.prototype,"content",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)({ref:"User"}),tslib_1.__metadata("design:type",Array)],Message.prototype,"likes",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type","function"==typeof(_c="undefined"!=typeof Date&&Date)?_c:Object)],Message.prototype,"creationDate",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type",Boolean)],Message.prototype,"hasLikes",void 0),Message=tslib_1.__decorate([(0,mongoose_1.Schema)()],Message),exports.Message=Message,exports.MessageSchema=mongoose_1.SchemaFactory.createForClass(Message)},3015:(__unused_webpack_module,exports,__webpack_require__)=>{var _a,_b,_c,_d,_e,_f,_g,_h;Object.defineProperty(exports,"__esModule",{value:!0}),exports.MessagesController=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),app_module_1=__webpack_require__(3029),object_id_pipe_1=__webpack_require__(3358),create_message_dto_1=__webpack_require__(7213),messages_service_1=__webpack_require__(4871),update_message_dto_1=__webpack_require__(7646);let MessagesController=class MessagesController{constructor(messagesService){this.messagesService=messagesService}getMessages(communityId,threadId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.messagesService.getMessages(communityId,threadId)}))}getMessageById(communityId,threadId,messageId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.messagesService.getMessageById(communityId,threadId,messageId)}))}createMessage(req,communityId,threadId,createMessageDto){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.messagesService.createMessage(req,communityId,threadId,createMessageDto)}))}likeMessage(req,communityId,threadId,messageId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.messagesService.likeMessage(req,communityId,threadId,messageId)}))}updateMessage(req,communityId,threadId,messageId,updateMessageDto){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.messagesService.updateMessage(req,communityId,threadId,messageId,updateMessageDto)}))}deleteMessage(req,communityId,threadId,messageId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.messagesService.deleteMessage(req,communityId,threadId,messageId)}))}};tslib_1.__decorate([(0,app_module_1.Public)(),(0,common_1.Get)(":communityId/thread/:threadId/message"),tslib_1.__param(0,(0,common_1.Param)("communityId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(1,(0,common_1.Param)("threadId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[String,String]),tslib_1.__metadata("design:returntype","function"==typeof(_b="undefined"!=typeof Promise&&Promise)?_b:Object)],MessagesController.prototype,"getMessages",null),tslib_1.__decorate([(0,app_module_1.Public)(),(0,common_1.Get)(":communityId/thread/:threadId/message/:messageId"),tslib_1.__param(0,(0,common_1.Param)("communityId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(1,(0,common_1.Param)("threadId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(2,(0,common_1.Param)("messageId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[String,String,String]),tslib_1.__metadata("design:returntype","function"==typeof(_c="undefined"!=typeof Promise&&Promise)?_c:Object)],MessagesController.prototype,"getMessageById",null),tslib_1.__decorate([(0,common_1.Post)(":communityId/thread/:threadId/message"),tslib_1.__param(0,(0,common_1.Req)()),tslib_1.__param(1,(0,common_1.Param)("communityId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(2,(0,common_1.Param)("threadId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(3,(0,common_1.Body)()),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object,String,String,"function"==typeof(_d=void 0!==create_message_dto_1.CreateMessageDto&&create_message_dto_1.CreateMessageDto)?_d:Object]),tslib_1.__metadata("design:returntype","function"==typeof(_e="undefined"!=typeof Promise&&Promise)?_e:Object)],MessagesController.prototype,"createMessage",null),tslib_1.__decorate([(0,common_1.Post)(":communityId/thread/:threadId/message/:messageId/like"),tslib_1.__param(0,(0,common_1.Req)()),tslib_1.__param(1,(0,common_1.Param)("communityId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(2,(0,common_1.Param)("threadId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(3,(0,common_1.Param)("messageId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object,String,String,String]),tslib_1.__metadata("design:returntype","function"==typeof(_f="undefined"!=typeof Promise&&Promise)?_f:Object)],MessagesController.prototype,"likeMessage",null),tslib_1.__decorate([(0,common_1.Patch)(":communityId/thread/:threadId/message/:messageId"),tslib_1.__param(0,(0,common_1.Req)()),tslib_1.__param(1,(0,common_1.Param)("communityId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(2,(0,common_1.Param)("threadId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(3,(0,common_1.Param)("messageId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(4,(0,common_1.Body)()),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object,String,String,String,"function"==typeof(_g=void 0!==update_message_dto_1.UpdateMessageDto&&update_message_dto_1.UpdateMessageDto)?_g:Object]),tslib_1.__metadata("design:returntype","function"==typeof(_h="undefined"!=typeof Promise&&Promise)?_h:Object)],MessagesController.prototype,"updateMessage",null),tslib_1.__decorate([(0,common_1.Delete)(":communityId/thread/:threadId/message/:messageId"),tslib_1.__param(0,(0,common_1.Req)()),tslib_1.__param(1,(0,common_1.Param)("communityId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(2,(0,common_1.Param)("threadId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(3,(0,common_1.Param)("messageId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object,String,String,String]),tslib_1.__metadata("design:returntype",Promise)],MessagesController.prototype,"deleteMessage",null),MessagesController=tslib_1.__decorate([(0,common_1.Controller)("community"),tslib_1.__metadata("design:paramtypes",["function"==typeof(_a=void 0!==messages_service_1.MessagesService&&messages_service_1.MessagesService)?_a:Object])],MessagesController),exports.MessagesController=MessagesController},8543:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.MessagesModule=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),mongoose_1=__webpack_require__(1794),communities_module_1=__webpack_require__(5467),message_schema_1=__webpack_require__(2829),messages_controller_1=__webpack_require__(3015),messages_service_1=__webpack_require__(4871);let MessagesModule=class MessagesModule{};MessagesModule=tslib_1.__decorate([(0,common_1.Module)({imports:[mongoose_1.MongooseModule.forFeature([{name:message_schema_1.Message.name,schema:message_schema_1.MessageSchema}]),communities_module_1.CommunitiesModule],controllers:[messages_controller_1.MessagesController],providers:[messages_service_1.MessagesService]})],MessagesModule),exports.MessagesModule=MessagesModule},4871:(__unused_webpack_module,exports,__webpack_require__)=>{var _a,_b;Object.defineProperty(exports,"__esModule",{value:!0}),exports.MessagesService=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),mongoose_1=__webpack_require__(1794),mongoose_2=__webpack_require__(1185),community_schema_1=__webpack_require__(5811),role_enum_1=__webpack_require__(4302),message_schema_1=__webpack_require__(2829);let MessagesService=class MessagesService{constructor(communityModel,messageModel){this.communityModel=communityModel,this.messageModel=messageModel}getMessageById(communityId,threadId,messageId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){yield this.existing(communityId,threadId,messageId);return(yield this.communityModel.findOne({_id:new mongoose_2.Types.ObjectId(communityId),"threads._id":new mongoose_2.Types.ObjectId(threadId),"messages._id":new mongoose_2.Types.ObjectId(messageId)})).threads.filter((p=>p._id.equals(new mongoose_2.Types.ObjectId(threadId))))[0].messages.filter((p=>p._id.equals(new mongoose_2.Types.ObjectId(messageId))))[0]}))}getMessages(communityId,threadId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){yield this.existing(communityId,threadId);return(yield this.communityModel.findOne({_id:new mongoose_2.Types.ObjectId(communityId),"threads._id":new mongoose_2.Types.ObjectId(threadId)})).threads.filter((p=>p._id.equals(new mongoose_2.Types.ObjectId(threadId))))[0].messages}))}createMessage(req,communityId,threadId,createMessageDto){return tslib_1.__awaiter(this,void 0,void 0,(function*(){yield this.existing(communityId,threadId);const currentCommunity=yield this.communityModel.findOne({_id:new mongoose_2.Types.ObjectId(communityId)});if(0===currentCommunity.members.filter((p=>p._id.equals(req.user.id))).length){if(currentCommunity.owner._id.equals(req.user.id)||req.user.roles.includes(role_enum_1.Role.Admin)){const id=new mongoose_2.Types.ObjectId,newMessage=new this.messageModel(Object.assign(Object.assign({_id:id,creator:req.user.id},createMessageDto),{likes:[],creationDate:new Date,hasLikes:!1}));return(yield this.communityModel.findOneAndUpdate({_id:new mongoose_2.Types.ObjectId(communityId),"threads._id":new mongoose_2.Types.ObjectId(threadId)},{$push:{"threads.$.messages":newMessage}},{new:!0})).threads.filter((p=>p._id.equals(new mongoose_2.Types.ObjectId(threadId))))[0].messages.filter((p=>p._id.equals(id)))[0]}throw new common_1.HttpException("Unauthorized",common_1.HttpStatus.UNAUTHORIZED)}{const id=new mongoose_2.Types.ObjectId,newMessage=new this.messageModel(Object.assign(Object.assign({_id:id,creator:req.user.id},createMessageDto),{likes:[],creationDate:new Date,hasLikes:!1}));return(yield this.communityModel.findOneAndUpdate({_id:new mongoose_2.Types.ObjectId(communityId),"threads._id":new mongoose_2.Types.ObjectId(threadId)},{$push:{"threads.$.messages":newMessage}},{new:!0})).threads.filter((p=>p._id.equals(new mongoose_2.Types.ObjectId(threadId))))[0].messages.filter((p=>p._id.equals(id)))[0]}}))}likeMessage(req,communityId,threadId,messageId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){yield this.existing(communityId,threadId,messageId);let result;return result=0===(yield this.getMessageById(communityId,threadId,messageId)).likes.filter((p=>p.equals(req.user.id))).length?yield this.communityModel.findOneAndUpdate({_id:new mongoose_2.Types.ObjectId(communityId),"threads._id":new mongoose_2.Types.ObjectId(threadId)},{$push:{"threads.$.messages.$[message].likes":req.user.id}},{arrayFilters:[{"message._id":new mongoose_2.Types.ObjectId(messageId)}],new:!0}):yield this.communityModel.findOneAndUpdate({_id:new mongoose_2.Types.ObjectId(communityId),"threads._id":new mongoose_2.Types.ObjectId(threadId)},{$pull:{"threads.$.messages.$[message].likes":req.user.id}},{arrayFilters:[{"message._id":new mongoose_2.Types.ObjectId(messageId)}],new:!0}),result=result.threads.filter((p=>p._id.equals(new mongoose_2.Types.ObjectId(threadId))))[0].messages.filter((p=>p._id.equals(new mongoose_2.Types.ObjectId(messageId))))[0].likes.length>0?yield this.communityModel.findOneAndUpdate({_id:new mongoose_2.Types.ObjectId(communityId),"threads._id":new mongoose_2.Types.ObjectId(threadId)},{$set:{"threads.$.messages.$[message].hasLikes":!0}},{arrayFilters:[{"message._id":new mongoose_2.Types.ObjectId(messageId)}],new:!0}):yield this.communityModel.findOneAndUpdate({_id:new mongoose_2.Types.ObjectId(communityId),"threads._id":new mongoose_2.Types.ObjectId(threadId)},{$set:{"threads.$.messages.$[message].hasLikes":!1}},{arrayFilters:[{"message._id":new mongoose_2.Types.ObjectId(messageId)}],new:!0}),result.threads.filter((p=>p._id.equals(new mongoose_2.Types.ObjectId(threadId))))[0].messages.filter((p=>p._id.equals(new mongoose_2.Types.ObjectId(messageId))))[0]}))}updateMessage(req,communityId,threadId,messageId,message){return tslib_1.__awaiter(this,void 0,void 0,(function*(){yield this.existing(communityId,threadId,messageId);if((yield this.communityModel.findOne({_id:new mongoose_2.Types.ObjectId(communityId)})).threads.filter((p=>p._id.equals(threadId)))[0].messages.filter((p=>p._id.equals(messageId)))[0].creator._id.equals(req.user.id)||req.user.roles.includes(role_enum_1.Role.Admin)){const oldMessage=yield this.getMessageById(communityId,threadId,messageId),newMessage=Object.assign(Object.assign({},oldMessage),message);return yield this.communityModel.findOneAndUpdate({_id:new mongoose_2.Types.ObjectId(communityId),"threads._id":new mongoose_2.Types.ObjectId(threadId)},{$pull:{"threads.$.messages":oldMessage}}),yield this.communityModel.findOneAndUpdate({_id:new mongoose_2.Types.ObjectId(communityId),"threads._id":new mongoose_2.Types.ObjectId(threadId)},{$push:{"threads.$.messages":newMessage}},{new:!0})}throw new common_1.HttpException("Unauthorized",common_1.HttpStatus.UNAUTHORIZED)}))}deleteMessage(req,communityId,threadId,messageId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){yield this.existing(communityId,threadId,messageId);if((yield this.communityModel.findOne({_id:new mongoose_2.Types.ObjectId(communityId)})).threads.filter((p=>p._id.equals(threadId)))[0].messages.filter((p=>p._id.equals(messageId)))[0].creator._id.equals(req.user.id)||req.user.roles.includes(role_enum_1.Role.Admin)){const message=yield this.getMessageById(communityId,threadId,messageId);return yield this.communityModel.findOneAndUpdate({_id:new mongoose_2.Types.ObjectId(communityId),"threads._id":new mongoose_2.Types.ObjectId(threadId)},{$pull:{"threads.$.messages":message}},{new:!0})}throw new common_1.HttpException("Unauthorized",common_1.HttpStatus.UNAUTHORIZED)}))}existing(communityId,threadId,messageId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){const community=yield this.communityModel.findOne({_id:new mongoose_2.Types.ObjectId(communityId)});if(!community)throw new common_1.HttpException(`Community with id ${communityId} does not exist!`,common_1.HttpStatus.BAD_REQUEST);if(threadId&&!(community.threads.filter((p=>p._id.equals(new mongoose_2.Types.ObjectId(threadId)))).length>0))throw new common_1.HttpException(`Thread with id ${threadId} doesn't exist in the community with id ${communityId}!`,common_1.HttpStatus.BAD_REQUEST);if(messageId&&!(community.threads.filter((p=>p._id.equals(new mongoose_2.Types.ObjectId(threadId))))[0].messages.filter((p=>p._id.equals(new mongoose_2.Types.ObjectId(messageId)))).length>0))throw new common_1.HttpException(`Message with id ${messageId} doesn't exist in the thread with id ${threadId} in the community with id ${communityId}!`,common_1.HttpStatus.BAD_REQUEST)}))}};MessagesService=tslib_1.__decorate([(0,common_1.Injectable)(),tslib_1.__param(0,(0,mongoose_1.InjectModel)(community_schema_1.Community.name)),tslib_1.__param(1,(0,mongoose_1.InjectModel)(message_schema_1.Message.name)),tslib_1.__metadata("design:paramtypes",["function"==typeof(_a=void 0!==mongoose_2.Model&&mongoose_2.Model)?_a:Object,"function"==typeof(_b=void 0!==mongoose_2.Model&&mongoose_2.Model)?_b:Object])],MessagesService),exports.MessagesService=MessagesService},7646:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.UpdateMessageDto=void 0;const tslib_1=__webpack_require__(752),class_validator_1=__webpack_require__(5849);class UpdateMessageDto{}tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsOptional)(),tslib_1.__metadata("design:type",String)],UpdateMessageDto.prototype,"content",void 0),exports.UpdateMessageDto=UpdateMessageDto},2660:(__unused_webpack_module,exports)=>{Object.defineProperty(exports,"__esModule",{value:!0})},6747:(__unused_webpack_module,exports)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.NEO4J_DRIVER=exports.NEO4J_CONFIG=void 0,exports.NEO4J_CONFIG="NEO4J_CONFIG",exports.NEO4J_DRIVER="NEO4J_DRIVER"},8558:(__unused_webpack_module,exports,__webpack_require__)=>{var Neo4jModule_1;Object.defineProperty(exports,"__esModule",{value:!0}),exports.Neo4jModule=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),neo4j_service_1=__webpack_require__(6397),neo4j_constants_1=__webpack_require__(6747),neo4j_util_1=__webpack_require__(4449);let Neo4jModule=Neo4jModule_1=class Neo4jModule{static forRoot(config){return{module:Neo4jModule_1,providers:[{provide:neo4j_constants_1.NEO4J_CONFIG,useValue:config},{provide:neo4j_constants_1.NEO4J_DRIVER,inject:[neo4j_constants_1.NEO4J_CONFIG],useFactory:config=>tslib_1.__awaiter(this,void 0,void 0,(function*(){return(0,neo4j_util_1.createDriver)(config)}))},neo4j_service_1.Neo4jService],exports:[neo4j_service_1.Neo4jService]}}};Neo4jModule=Neo4jModule_1=tslib_1.__decorate([(0,common_1.Module)({})],Neo4jModule),exports.Neo4jModule=Neo4jModule},6397:(__unused_webpack_module,exports,__webpack_require__)=>{var _a,_b;Object.defineProperty(exports,"__esModule",{value:!0}),exports.Neo4jService=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),neo4j_config_interface_1=__webpack_require__(2660),neo4j_constants_1=__webpack_require__(6747),neo4j_driver_1=__webpack_require__(3255);let Neo4jService=class Neo4jService{constructor(config,driver){this.config=config,this.driver=driver}getDriver(){return this.driver}getConfig(){return this.config}getReadSession(database){return this.driver.session({database:database||this.config.database,defaultAccessMode:neo4j_driver_1.default.session.READ})}getWriteSession(database){return this.driver.session({database:database||this.config.database,defaultAccessMode:neo4j_driver_1.default.session.WRITE})}read(cypher,params,database){return this.getReadSession(database).run(cypher,params)}write(cypher,params,database){return this.getWriteSession(database).run(cypher,params)}};Neo4jService=tslib_1.__decorate([(0,common_1.Injectable)(),tslib_1.__param(0,(0,common_1.Inject)(neo4j_constants_1.NEO4J_CONFIG)),tslib_1.__param(1,(0,common_1.Inject)(neo4j_constants_1.NEO4J_DRIVER)),tslib_1.__metadata("design:paramtypes",["function"==typeof(_a=void 0!==neo4j_config_interface_1.Neo4jConfig&&neo4j_config_interface_1.Neo4jConfig)?_a:Object,"function"==typeof(_b=void 0!==neo4j_driver_1.Driver&&neo4j_driver_1.Driver)?_b:Object])],Neo4jService),exports.Neo4jService=Neo4jService},4449:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.createDriver=void 0;const tslib_1=__webpack_require__(752),neo4j_driver_1=__webpack_require__(3255);exports.createDriver=config=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){console.log(`${config.scheme}://${config.host}:${config.port}`);const driver=neo4j_driver_1.default.driver(`${config.scheme}://${config.host}:${config.port}`,neo4j_driver_1.default.auth.basic(config.username,config.password));return yield driver.verifyConnectivity(),driver}))},2046:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.ValidationException=void 0;const common_1=__webpack_require__(6481);class ValidationException extends common_1.BadRequestException{constructor(validationErrors){super(),this.validationErrors=validationErrors}}exports.ValidationException=ValidationException},9764:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.ValidationFilter=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),validation_exception_1=__webpack_require__(2046);let ValidationFilter=class ValidationFilter{catch(exception,host){return host.switchToHttp().getResponse().status(400).json({statusCode:400,timeStamp:new Date,createdBy:"ValidationFilter",validationErrors:exception.validationErrors})}};ValidationFilter=tslib_1.__decorate([(0,common_1.Catch)(validation_exception_1.ValidationException)],ValidationFilter),exports.ValidationFilter=ValidationFilter},3358:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.ObjectIdPipe=void 0;const validation_exception_1=__webpack_require__(2046);var ObjectId=__webpack_require__(1185).Types.ObjectId;exports.ObjectIdPipe=class ObjectIdPipe{transform(value){if(!ObjectId.isValid(value))throw new validation_exception_1.ValidationException([`ObjectId has wrong value: ${value}, ObjectId is not valid!`]);return value}static isValidObjectId(value){try{return ObjectId.createFromHexString(value),!0}catch(error){return!1}}}},9885:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.CreateThemeDto=void 0;const tslib_1=__webpack_require__(752),class_validator_1=__webpack_require__(5849);class CreateThemeDto{}tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsNotEmpty)(),(0,class_validator_1.IsDefined)(),tslib_1.__metadata("design:type",String)],CreateThemeDto.prototype,"name",void 0),exports.CreateThemeDto=CreateThemeDto},5194:(__unused_webpack_module,exports,__webpack_require__)=>{var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.ThemeSchema=exports.Theme=void 0;const tslib_1=__webpack_require__(752),mongoose_1=__webpack_require__(1794),mongoose_2=__webpack_require__(1185);let Theme=class Theme{};tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type","function"==typeof(_a=void 0!==mongoose_2.Types&&mongoose_2.Types.ObjectId)?_a:Object)],Theme.prototype,"_id",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type",String)],Theme.prototype,"name",void 0),Theme=tslib_1.__decorate([(0,mongoose_1.Schema)()],Theme),exports.Theme=Theme,exports.ThemeSchema=mongoose_1.SchemaFactory.createForClass(Theme)},1826:(__unused_webpack_module,exports,__webpack_require__)=>{var _a,_b,_c,_d,_e,_f;Object.defineProperty(exports,"__esModule",{value:!0}),exports.ThemesController=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),app_module_1=__webpack_require__(3029),roles_decorator_1=__webpack_require__(8851),object_id_pipe_1=__webpack_require__(3358),role_enum_1=__webpack_require__(4302),create_theme_dto_1=__webpack_require__(9885),themes_service_1=__webpack_require__(9493);let ThemesController=class ThemesController{constructor(themeService){this.themeService=themeService}getThemes(){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.themeService.getThemes()}))}getThemeById(id){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.themeService.getThemeById(id)}))}createTheme(createThemeDto){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.themeService.createTheme(createThemeDto.name)}))}deleteTheme(id){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.themeService.deleteTheme(id)}))}};tslib_1.__decorate([(0,app_module_1.Public)(),(0,common_1.Get)(),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[]),tslib_1.__metadata("design:returntype","function"==typeof(_b="undefined"!=typeof Promise&&Promise)?_b:Object)],ThemesController.prototype,"getThemes",null),tslib_1.__decorate([(0,app_module_1.Public)(),(0,common_1.Get)(":id"),tslib_1.__param(0,(0,common_1.Param)("id",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[String]),tslib_1.__metadata("design:returntype","function"==typeof(_c="undefined"!=typeof Promise&&Promise)?_c:Object)],ThemesController.prototype,"getThemeById",null),tslib_1.__decorate([(0,roles_decorator_1.Roles)(role_enum_1.Role.Admin),(0,common_1.Post)(),tslib_1.__param(0,(0,common_1.Body)()),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",["function"==typeof(_d=void 0!==create_theme_dto_1.CreateThemeDto&&create_theme_dto_1.CreateThemeDto)?_d:Object]),tslib_1.__metadata("design:returntype","function"==typeof(_e="undefined"!=typeof Promise&&Promise)?_e:Object)],ThemesController.prototype,"createTheme",null),tslib_1.__decorate([(0,roles_decorator_1.Roles)(role_enum_1.Role.Admin),(0,common_1.Delete)(":id"),tslib_1.__param(0,(0,common_1.Param)("id",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[String]),tslib_1.__metadata("design:returntype","function"==typeof(_f="undefined"!=typeof Promise&&Promise)?_f:Object)],ThemesController.prototype,"deleteTheme",null),ThemesController=tslib_1.__decorate([(0,common_1.Controller)("theme"),tslib_1.__metadata("design:paramtypes",["function"==typeof(_a=void 0!==themes_service_1.ThemesService&&themes_service_1.ThemesService)?_a:Object])],ThemesController),exports.ThemesController=ThemesController},4894:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.ThemesModule=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),mongoose_1=__webpack_require__(1794),theme_schema_1=__webpack_require__(5194),themes_controller_1=__webpack_require__(1826),themes_service_1=__webpack_require__(9493);let ThemesModule=class ThemesModule{};ThemesModule=tslib_1.__decorate([(0,common_1.Module)({imports:[mongoose_1.MongooseModule.forFeature([{name:theme_schema_1.Theme.name,schema:theme_schema_1.ThemeSchema}])],controllers:[themes_controller_1.ThemesController],providers:[themes_service_1.ThemesService],exports:[themes_service_1.ThemesService]})],ThemesModule),exports.ThemesModule=ThemesModule},9493:(__unused_webpack_module,exports,__webpack_require__)=>{var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.ThemesService=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),mongoose_1=__webpack_require__(1185),theme_schema_1=__webpack_require__(5194),mongoose_2=__webpack_require__(1794);let ThemesService=class ThemesService{constructor(themeModel){this.themeModel=themeModel}getThemeById(id){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.existing(id),this.themeModel.findOne({_id:new mongoose_1.Types.ObjectId(id)})}))}getThemes(){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return this.themeModel.find({})}))}createTheme(name){return tslib_1.__awaiter(this,void 0,void 0,(function*(){if((yield this.getThemes()).filter((p=>p.name===name)).length>0)throw new common_1.HttpException("A Theme with this name already exists!",common_1.HttpStatus.BAD_REQUEST);return new this.themeModel({_id:new mongoose_1.Types.ObjectId,name}).save()}))}deleteTheme(id){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.existing(id),this.themeModel.findOneAndDelete({_id:new mongoose_1.Types.ObjectId(id)})}))}existing(themeId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){if(!(yield this.themeModel.findOne({_id:new mongoose_1.Types.ObjectId(themeId)})))throw new common_1.HttpException(`Theme with id ${themeId} does not exist!`,common_1.HttpStatus.BAD_REQUEST)}))}};ThemesService=tslib_1.__decorate([(0,common_1.Injectable)(),tslib_1.__param(0,(0,mongoose_2.InjectModel)(theme_schema_1.Theme.name)),tslib_1.__metadata("design:paramtypes",["function"==typeof(_a=void 0!==mongoose_1.Model&&mongoose_1.Model)?_a:Object])],ThemesService),exports.ThemesService=ThemesService},9846:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.CreateThreadDto=void 0;const tslib_1=__webpack_require__(752),class_validator_1=__webpack_require__(5849);class CreateThreadDto{}tslib_1.__decorate([(0,class_validator_1.IsString)(),tslib_1.__metadata("design:type",String)],CreateThreadDto.prototype,"title",void 0),tslib_1.__decorate([(0,class_validator_1.IsString)(),tslib_1.__metadata("design:type",String)],CreateThreadDto.prototype,"content",void 0),tslib_1.__decorate([(0,class_validator_1.IsString)(),tslib_1.__metadata("design:type",String)],CreateThreadDto.prototype,"image",void 0),exports.CreateThreadDto=CreateThreadDto},1515:(__unused_webpack_module,exports,__webpack_require__)=>{var _a,_b,_c;Object.defineProperty(exports,"__esModule",{value:!0}),exports.ThreadSchema=exports.Thread=void 0;const tslib_1=__webpack_require__(752),mongoose_1=__webpack_require__(1794),mongoose_2=__webpack_require__(1185);let Thread=class Thread{};tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type","function"==typeof(_a=void 0!==mongoose_2.Types&&mongoose_2.Types.ObjectId)?_a:Object)],Thread.prototype,"_id",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type",String)],Thread.prototype,"title",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type",String)],Thread.prototype,"content",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type",Number)],Thread.prototype,"views",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)({ref:"User"}),tslib_1.__metadata("design:type",Array)],Thread.prototype,"likes",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type","function"==typeof(_b="undefined"!=typeof Date&&Date)?_b:Object)],Thread.prototype,"creationDate",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type",String)],Thread.prototype,"image",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)({default:[]}),tslib_1.__metadata("design:type",Array)],Thread.prototype,"messages",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)({ref:"User"}),tslib_1.__metadata("design:type","function"==typeof(_c=void 0!==mongoose_2.Types&&mongoose_2.Types.ObjectId)?_c:Object)],Thread.prototype,"creator",void 0),Thread=tslib_1.__decorate([(0,mongoose_1.Schema)()],Thread),exports.Thread=Thread,exports.ThreadSchema=mongoose_1.SchemaFactory.createForClass(Thread)},4978:(__unused_webpack_module,exports,__webpack_require__)=>{var _a,_b,_c,_d,_e,_f,_g,_h;Object.defineProperty(exports,"__esModule",{value:!0}),exports.ThreadsController=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),threads_service_1=__webpack_require__(3046),update_thread_dto_1=__webpack_require__(7600),create_thread_dto_1=__webpack_require__(9846),app_module_1=__webpack_require__(3029),object_id_pipe_1=__webpack_require__(3358);let ThreadsController=class ThreadsController{constructor(threadService){this.threadService=threadService}getThreads(communityId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.threadService.getThreads(communityId)}))}getThreadById(communityId,threadId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.threadService.getThreadById(communityId,threadId)}))}createThread(req,createThreadDto,communityId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.threadService.createThread(req,communityId,createThreadDto)}))}likeThread(req,communityId,threadId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.threadService.likeThread(req,communityId,threadId)}))}viewThread(communityId,threadId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.threadService.viewThread(communityId,threadId)}))}updateThread(req,communityId,threadId,updateThreadDto){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.threadService.updateThread(communityId,threadId,req,updateThreadDto)}))}deleteThread(req,communityId,threadId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.threadService.deleteThread(communityId,threadId,req)}))}};tslib_1.__decorate([(0,app_module_1.Public)(),(0,common_1.Get)(":communityId/thread"),tslib_1.__param(0,(0,common_1.Param)("communityId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[String]),tslib_1.__metadata("design:returntype","function"==typeof(_b="undefined"!=typeof Promise&&Promise)?_b:Object)],ThreadsController.prototype,"getThreads",null),tslib_1.__decorate([(0,app_module_1.Public)(),(0,common_1.Get)(":communityId/thread/:threadId"),tslib_1.__param(0,(0,common_1.Param)("communityId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(1,(0,common_1.Param)("threadId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[String,String]),tslib_1.__metadata("design:returntype","function"==typeof(_c="undefined"!=typeof Promise&&Promise)?_c:Object)],ThreadsController.prototype,"getThreadById",null),tslib_1.__decorate([(0,common_1.Post)(":communityId/thread"),tslib_1.__param(0,(0,common_1.Req)()),tslib_1.__param(1,(0,common_1.Body)()),tslib_1.__param(2,(0,common_1.Param)("communityId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object,"function"==typeof(_d=void 0!==create_thread_dto_1.CreateThreadDto&&create_thread_dto_1.CreateThreadDto)?_d:Object,String]),tslib_1.__metadata("design:returntype","function"==typeof(_e="undefined"!=typeof Promise&&Promise)?_e:Object)],ThreadsController.prototype,"createThread",null),tslib_1.__decorate([(0,common_1.Post)(":communityId/thread/:threadId/like"),tslib_1.__param(0,(0,common_1.Req)()),tslib_1.__param(1,(0,common_1.Param)("communityId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(2,(0,common_1.Param)("threadId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object,String,String]),tslib_1.__metadata("design:returntype",Promise)],ThreadsController.prototype,"likeThread",null),tslib_1.__decorate([(0,app_module_1.Public)(),(0,common_1.Post)(":communityId/thread/:threadId/view"),tslib_1.__param(0,(0,common_1.Param)("communityId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(1,(0,common_1.Param)("threadId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[String,String]),tslib_1.__metadata("design:returntype",Promise)],ThreadsController.prototype,"viewThread",null),tslib_1.__decorate([(0,common_1.Patch)(":communityId/thread/:threadId"),tslib_1.__param(0,(0,common_1.Req)()),tslib_1.__param(1,(0,common_1.Param)("communityId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(2,(0,common_1.Param)("threadId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(3,(0,common_1.Body)()),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object,String,String,"function"==typeof(_f=void 0!==update_thread_dto_1.UpdateThreadDto&&update_thread_dto_1.UpdateThreadDto)?_f:Object]),tslib_1.__metadata("design:returntype","function"==typeof(_g="undefined"!=typeof Promise&&Promise)?_g:Object)],ThreadsController.prototype,"updateThread",null),tslib_1.__decorate([(0,common_1.Delete)(":communityId/thread/:threadId"),tslib_1.__param(0,(0,common_1.Req)()),tslib_1.__param(1,(0,common_1.Param)("communityId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(2,(0,common_1.Param)("threadId",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object,String,String]),tslib_1.__metadata("design:returntype","function"==typeof(_h="undefined"!=typeof Promise&&Promise)?_h:Object)],ThreadsController.prototype,"deleteThread",null),ThreadsController=tslib_1.__decorate([(0,common_1.Controller)("community"),tslib_1.__metadata("design:paramtypes",["function"==typeof(_a=void 0!==threads_service_1.ThreadsService&&threads_service_1.ThreadsService)?_a:Object])],ThreadsController),exports.ThreadsController=ThreadsController},6893:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.ThreadsModule=void 0;const tslib_1=__webpack_require__(752),mongoose_1=__webpack_require__(1794),common_1=__webpack_require__(6481),thread_schema_1=__webpack_require__(1515),threads_controller_1=__webpack_require__(4978),threads_service_1=__webpack_require__(3046),users_module_1=__webpack_require__(9568),communities_module_1=__webpack_require__(5467);let ThreadsModule=class ThreadsModule{};ThreadsModule=tslib_1.__decorate([(0,common_1.Module)({imports:[mongoose_1.MongooseModule.forFeature([{name:thread_schema_1.Thread.name,schema:thread_schema_1.ThreadSchema}]),users_module_1.UsersModule,communities_module_1.CommunitiesModule],controllers:[threads_controller_1.ThreadsController],providers:[threads_service_1.ThreadsService]})],ThreadsModule),exports.ThreadsModule=ThreadsModule},3046:(__unused_webpack_module,exports,__webpack_require__)=>{var _a,_b,_c,_d;Object.defineProperty(exports,"__esModule",{value:!0}),exports.ThreadsService=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),mongoose_1=__webpack_require__(1185),thread_schema_1=__webpack_require__(1515),users_service_1=__webpack_require__(8223),mongoose_2=__webpack_require__(1794),community_schema_1=__webpack_require__(5811),communities_service_1=__webpack_require__(8345),role_enum_1=__webpack_require__(4302);let ThreadsService=class ThreadsService{constructor(communityModel,threadModel,usersService,communitiesService){this.communityModel=communityModel,this.threadModel=threadModel,this.usersService=usersService,this.communitiesService=communitiesService}getThreadById(communityId,threadId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.existing(communityId,threadId),(yield this.communityModel.aggregate([{$match:{_id:new mongoose_1.Types.ObjectId(communityId)}},{$match:{"threads._id":new mongoose_1.Types.ObjectId(threadId)}},{$unwind:{path:"$members",preserveNullAndEmptyArrays:!0}},{$project:{_id:0,threads:{$filter:{input:"$threads",as:"thread",cond:{$eq:["$$thread._id",new mongoose_1.Types.ObjectId(threadId)]}}}}},{$unwind:{path:"$threads",preserveNullAndEmptyArrays:!0}},{$lookup:{from:"users",localField:"threads.creator",foreignField:"_id",as:"threads.creator"}},{$unwind:{path:"$threads.messages",preserveNullAndEmptyArrays:!0}},{$lookup:{from:"users",localField:"threads.messages.creator",foreignField:"_id",as:"threads.messages.creator"}},{$set:{"threads.messages.creator":"$threads.messages.creator"}},{$group:{_id:"$threads._id",title:{$first:"$threads.title"},content:{$first:"$threads.content"},views:{$first:"$threads.views"},likes:{$first:"$threads.likes"},creationDate:{$first:"$threads.creationDate"},image:{$first:"$threads.image"},messages:{$push:"$threads.messages"},creator:{$first:"$threads.creator"}}},{$unset:["creator.password","creator.__v","messages.creator.password","messages.creator.__v"]}]))[0]}))}getThreads(communityId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.existing(communityId),yield this.communityModel.aggregate([{$match:{_id:new mongoose_1.Types.ObjectId(communityId)}},{$unwind:{path:"$members",preserveNullAndEmptyArrays:!0}},{$project:{_id:0,threads:{$filter:{input:"$threads",as:"thread",cond:!0}}}},{$unwind:{path:"$threads",preserveNullAndEmptyArrays:!1}},{$lookup:{from:"users",localField:"threads.creator",foreignField:"_id",as:"threads.creator"}},{$unwind:{path:"$threads.messages",preserveNullAndEmptyArrays:!0}},{$lookup:{from:"users",localField:"threads.messages.creator",foreignField:"_id",as:"threads.messages.creator"}},{$set:{"threads.messages.creator":"$threads.messages.creator"}},{$group:{_id:"$threads._id",title:{$first:"$threads.title"},content:{$first:"$threads.content"},views:{$first:"$threads.views"},likes:{$first:"$threads.likes"},creationDate:{$first:"$threads.creationDate"},image:{$first:"$threads.image"},messages:{$push:"$threads.messages"},creator:{$first:"$threads.creator"}}},{$unset:["creator.password","creator.__v","messages.creator.password","messages.creator.__v"]}])}))}createThread(req,communityId,createThreadDto){return tslib_1.__awaiter(this,void 0,void 0,(function*(){if(yield this.existing(communityId),0===(yield this.communitiesService.getCommunityById(communityId)).members.filter((p=>p._id.equals(req.user.id))).length){if((yield this.communitiesService.getCommunityById(communityId)).owner._id.equals(req.user.id)||req.user.roles.includes(role_enum_1.Role.Admin)){const newThread=new this.threadModel(Object.assign(Object.assign({},createThreadDto),{_id:new mongoose_1.Types.ObjectId,views:0,creationDate:new Date,creator:req.user.id}));return yield this.communityModel.findOneAndUpdate({_id:new mongoose_1.Types.ObjectId(communityId)},{$push:{threads:newThread}})}throw new common_1.HttpException("Unauthorized",common_1.HttpStatus.UNAUTHORIZED)}{const newThread=new this.threadModel(Object.assign(Object.assign({},createThreadDto),{_id:new mongoose_1.Types.ObjectId,views:0,creationDate:new Date,creator:req.user.id}));return yield this.communityModel.findOneAndUpdate({_id:new mongoose_1.Types.ObjectId(communityId)},{$push:{threads:newThread}})}}))}likeThread(req,communityId,threadId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){let community;return yield this.existing(communityId,threadId),community=0===(yield this.communityModel.find({$and:[{_id:new mongoose_1.Types.ObjectId(communityId)},{threads:{$elemMatch:{_id:new mongoose_1.Types.ObjectId(threadId),likes:{$in:[req.user.id]}}}}]})).length?yield this.communityModel.findOneAndUpdate({_id:new mongoose_1.Types.ObjectId(communityId),"threads._id":new mongoose_1.Types.ObjectId(threadId)},{$push:{"threads.$.likes":req.user.id}},{new:!0}):yield this.communityModel.findOneAndUpdate({_id:new mongoose_1.Types.ObjectId(communityId),"threads._id":new mongoose_1.Types.ObjectId(threadId)},{$pull:{"threads.$.likes":req.user.id}},{new:!0}),community.threads.filter((p=>p._id.equals(new mongoose_1.Types.ObjectId(threadId))))[0]}))}viewThread(communityId,threadId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.existing(communityId,threadId),(yield this.communityModel.findOneAndUpdate({_id:new mongoose_1.Types.ObjectId(communityId),"threads._id":new mongoose_1.Types.ObjectId(threadId)},{$inc:{"threads.$.views":1}})).threads.filter((p=>p._id.equals(new mongoose_1.Types.ObjectId(threadId))))[0]}))}updateThread(communityId,threadId,req,updateThreadDto){return tslib_1.__awaiter(this,void 0,void 0,(function*(){yield this.existing(communityId,threadId);const thread=(yield this.communityModel.findOne({_id:new mongoose_1.Types.ObjectId(communityId)},{threads:{$elemMatch:{_id:new mongoose_1.Types.ObjectId(threadId)}}})).threads.filter((thread=>tslib_1.__awaiter(this,void 0,void 0,(function*(){return thread._id.equals(new mongoose_1.Types.ObjectId(threadId))}))))[0];if(!(yield req.user.id.equals(thread.creator))&&!req.user.roles.includes(role_enum_1.Role.Admin))throw new common_1.HttpException("Unauthorized",common_1.HttpStatus.UNAUTHORIZED);return yield this.communityModel.findOneAndUpdate({_id:new mongoose_1.Types.ObjectId(communityId),"threads._id":new mongoose_1.Types.ObjectId(threadId)},{$set:{"threads.$":Object.assign(Object.assign({},thread),updateThreadDto)}},{new:!0})}))}deleteThread(communityId,threadId,req){return tslib_1.__awaiter(this,void 0,void 0,(function*(){yield this.existing(communityId,threadId);const thread=(yield this.communityModel.findOne({_id:new mongoose_1.Types.ObjectId(communityId)},{threads:{$elemMatch:{_id:new mongoose_1.Types.ObjectId(threadId)}}})).threads.filter((thread=>tslib_1.__awaiter(this,void 0,void 0,(function*(){return thread._id.equals(new mongoose_1.Types.ObjectId(threadId))}))))[0];if(!(yield req.user.id.equals(thread.creator))&&!req.user.roles.includes(role_enum_1.Role.Admin))throw new common_1.HttpException("Unauthorized",common_1.HttpStatus.UNAUTHORIZED);return yield this.communityModel.findOneAndUpdate({_id:new mongoose_1.Types.ObjectId(communityId)},{$pull:{threads:{_id:new mongoose_1.Types.ObjectId(threadId)}}},{new:!0})}))}existing(communityId,threadId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){const community=yield this.communityModel.findOne({_id:new mongoose_1.Types.ObjectId(communityId)});if(!community)throw new common_1.HttpException(`Community with id ${communityId} does not exist!`,common_1.HttpStatus.BAD_REQUEST);if(threadId&&!(community.threads.filter((thread=>thread._id.equals(new mongoose_1.Types.ObjectId(threadId)))).length>0))throw new common_1.HttpException(`Thread with id ${threadId} doesn't exist in the community with id ${communityId}!`,common_1.HttpStatus.BAD_REQUEST)}))}};ThreadsService=tslib_1.__decorate([(0,common_1.Injectable)(),tslib_1.__param(0,(0,mongoose_2.InjectModel)(community_schema_1.Community.name)),tslib_1.__param(1,(0,mongoose_2.InjectModel)(thread_schema_1.Thread.name)),tslib_1.__metadata("design:paramtypes",["function"==typeof(_a=void 0!==mongoose_1.Model&&mongoose_1.Model)?_a:Object,"function"==typeof(_b=void 0!==mongoose_1.Model&&mongoose_1.Model)?_b:Object,"function"==typeof(_c=void 0!==users_service_1.UsersService&&users_service_1.UsersService)?_c:Object,"function"==typeof(_d=void 0!==communities_service_1.CommunitiesService&&communities_service_1.CommunitiesService)?_d:Object])],ThreadsService),exports.ThreadsService=ThreadsService},7600:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.UpdateThreadDto=void 0;const tslib_1=__webpack_require__(752),class_validator_1=__webpack_require__(5849);class UpdateThreadDto{}tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsOptional)(),tslib_1.__metadata("design:type",String)],UpdateThreadDto.prototype,"title",void 0),tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsOptional)(),tslib_1.__metadata("design:type",String)],UpdateThreadDto.prototype,"content",void 0),tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsOptional)(),tslib_1.__metadata("design:type",String)],UpdateThreadDto.prototype,"image",void 0),exports.UpdateThreadDto=UpdateThreadDto},4837:(__unused_webpack_module,exports,__webpack_require__)=>{var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.CreateUserDto=void 0;const tslib_1=__webpack_require__(752),class_validator_1=__webpack_require__(5849);class CreateUserDto{}tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsNotEmpty)(),(0,class_validator_1.IsDefined)(),tslib_1.__metadata("design:type",String)],CreateUserDto.prototype,"username",void 0),tslib_1.__decorate([(0,class_validator_1.Matches)(/^\d{4}[./-]\d{2}[./-]\d{2}$/),(0,class_validator_1.IsNotEmpty)(),(0,class_validator_1.IsDefined)(),tslib_1.__metadata("design:type","function"==typeof(_a="undefined"!=typeof Date&&Date)?_a:Object)],CreateUserDto.prototype,"birthDate",void 0),tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsNotEmpty)(),(0,class_validator_1.IsDefined)(),tslib_1.__metadata("design:type",String)],CreateUserDto.prototype,"emailAddress",void 0),tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsNotEmpty)(),(0,class_validator_1.IsDefined)(),tslib_1.__metadata("design:type",String)],CreateUserDto.prototype,"phoneNumber",void 0),tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsNotEmpty)(),(0,class_validator_1.IsDefined)(),tslib_1.__metadata("design:type",String)],CreateUserDto.prototype,"password",void 0),tslib_1.__decorate([(0,class_validator_1.IsString)(),tslib_1.__metadata("design:type",String)],CreateUserDto.prototype,"image",void 0),exports.CreateUserDto=CreateUserDto},4302:(__unused_webpack_module,exports)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.Role=void 0,function(Role){Role.User="user",Role.Admin="admin"}(exports.Role||(exports.Role={}))},436:(__unused_webpack_module,exports,__webpack_require__)=>{var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.UpdateUserDto=void 0;const tslib_1=__webpack_require__(752),class_validator_1=__webpack_require__(5849);class UpdateUserDto{}tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsOptional)(),tslib_1.__metadata("design:type",String)],UpdateUserDto.prototype,"username",void 0),tslib_1.__decorate([(0,class_validator_1.Matches)(/^\d{4}[./-]\d{2}[./-]\d{2}$/),(0,class_validator_1.IsOptional)(),tslib_1.__metadata("design:type","function"==typeof(_a="undefined"!=typeof Date&&Date)?_a:Object)],UpdateUserDto.prototype,"birthDate",void 0),tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsOptional)(),tslib_1.__metadata("design:type",String)],UpdateUserDto.prototype,"emailAddress",void 0),tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsOptional)(),tslib_1.__metadata("design:type",String)],UpdateUserDto.prototype,"phoneNumber",void 0),tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsOptional)(),tslib_1.__metadata("design:type",String)],UpdateUserDto.prototype,"password",void 0),tslib_1.__decorate([(0,class_validator_1.IsString)(),(0,class_validator_1.IsOptional)(),tslib_1.__metadata("design:type",String)],UpdateUserDto.prototype,"image",void 0),exports.UpdateUserDto=UpdateUserDto},8366:(__unused_webpack_module,exports,__webpack_require__)=>{var _a,_b,_c;Object.defineProperty(exports,"__esModule",{value:!0}),exports.UserSchema=exports.User=void 0;const tslib_1=__webpack_require__(752),mongoose_1=__webpack_require__(1794),mongoose_2=__webpack_require__(1185);let User=class User{};tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type","function"==typeof(_a=void 0!==mongoose_2.Types&&mongoose_2.Types.ObjectId)?_a:Object)],User.prototype,"_id",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)({unique:!0}),tslib_1.__metadata("design:type",String)],User.prototype,"username",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type","function"==typeof(_b="undefined"!=typeof Date&&Date)?_b:Object)],User.prototype,"birthDate",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type",String)],User.prototype,"emailAddress",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type",String)],User.prototype,"phoneNumber",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type",String)],User.prototype,"password",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type","function"==typeof(_c="undefined"!=typeof Date&&Date)?_c:Object)],User.prototype,"registerDate",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type",String)],User.prototype,"image",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type",Boolean)],User.prototype,"isActive",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)(),tslib_1.__metadata("design:type",Array)],User.prototype,"roles",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)({ref:"User"}),tslib_1.__metadata("design:type",Array)],User.prototype,"following",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)({ref:"User"}),tslib_1.__metadata("design:type",Array)],User.prototype,"followers",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)({ref:"Community",default:[]}),tslib_1.__metadata("design:type",Array)],User.prototype,"createdCommunities",void 0),tslib_1.__decorate([(0,mongoose_1.Prop)({ref:"Community",default:[]}),tslib_1.__metadata("design:type",Array)],User.prototype,"joinedCommunities",void 0),User=tslib_1.__decorate([(0,mongoose_1.Schema)()],User),exports.User=User,exports.UserSchema=mongoose_1.SchemaFactory.createForClass(User)},835:(__unused_webpack_module,exports,__webpack_require__)=>{var _a,_b,_c,_d,_e,_f,_g,_h,_j,_k;Object.defineProperty(exports,"__esModule",{value:!0}),exports.UsersController=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),roles_decorator_1=__webpack_require__(8851),object_id_pipe_1=__webpack_require__(3358),create_user_dto_1=__webpack_require__(4837),role_enum_1=__webpack_require__(4302),update_user_dto_1=__webpack_require__(436),users_service_1=__webpack_require__(8223);let UsersController=class UsersController{constructor(userService){this.userService=userService}getUsers(){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.userService.getUsers()}))}getUserById(id){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.userService.getUserById(id)}))}getUserByUsername(username){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.userService.getUserByUsername(username)}))}followUser(req,id){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.userService.followUser(req,id)}))}unfollowUser(req,id){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.userService.unfollowUser(req,id)}))}createUser(createUserDto){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.userService.createUser(createUserDto.username,createUserDto.birthDate,createUserDto.emailAddress,createUserDto.phoneNumber,createUserDto.password,createUserDto.image)}))}updateUser(req,id,updateUserDto){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.userService.updateUser(req,id,updateUserDto)}))}};tslib_1.__decorate([(0,common_1.Get)(),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[]),tslib_1.__metadata("design:returntype","function"==typeof(_b="undefined"!=typeof Promise&&Promise)?_b:Object)],UsersController.prototype,"getUsers",null),tslib_1.__decorate([(0,common_1.Get)(":id"),tslib_1.__param(0,(0,common_1.Param)("id",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[String]),tslib_1.__metadata("design:returntype","function"==typeof(_c="undefined"!=typeof Promise&&Promise)?_c:Object)],UsersController.prototype,"getUserById",null),tslib_1.__decorate([(0,common_1.Get)(":username"),tslib_1.__param(0,(0,common_1.Param)("username")),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[String]),tslib_1.__metadata("design:returntype","function"==typeof(_d="undefined"!=typeof Promise&&Promise)?_d:Object)],UsersController.prototype,"getUserByUsername",null),tslib_1.__decorate([(0,common_1.Post)(":id/follow"),tslib_1.__param(0,(0,common_1.Req)()),tslib_1.__param(1,(0,common_1.Param)("id",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object,String]),tslib_1.__metadata("design:returntype","function"==typeof(_e="undefined"!=typeof Promise&&Promise)?_e:Object)],UsersController.prototype,"followUser",null),tslib_1.__decorate([(0,common_1.Post)(":id/unfollow"),tslib_1.__param(0,(0,common_1.Req)()),tslib_1.__param(1,(0,common_1.Param)("id",object_id_pipe_1.ObjectIdPipe)),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object,String]),tslib_1.__metadata("design:returntype","function"==typeof(_f="undefined"!=typeof Promise&&Promise)?_f:Object)],UsersController.prototype,"unfollowUser",null),tslib_1.__decorate([(0,common_1.Post)(),(0,roles_decorator_1.Roles)(role_enum_1.Role.Admin),tslib_1.__param(0,(0,common_1.Body)()),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",["function"==typeof(_g=void 0!==create_user_dto_1.CreateUserDto&&create_user_dto_1.CreateUserDto)?_g:Object]),tslib_1.__metadata("design:returntype","function"==typeof(_h="undefined"!=typeof Promise&&Promise)?_h:Object)],UsersController.prototype,"createUser",null),tslib_1.__decorate([(0,common_1.Patch)(":id"),tslib_1.__param(0,(0,common_1.Req)()),tslib_1.__param(1,(0,common_1.Param)("id",object_id_pipe_1.ObjectIdPipe)),tslib_1.__param(2,(0,common_1.Body)()),tslib_1.__metadata("design:type",Function),tslib_1.__metadata("design:paramtypes",[Object,String,"function"==typeof(_j=void 0!==update_user_dto_1.UpdateUserDto&&update_user_dto_1.UpdateUserDto)?_j:Object]),tslib_1.__metadata("design:returntype","function"==typeof(_k="undefined"!=typeof Promise&&Promise)?_k:Object)],UsersController.prototype,"updateUser",null),UsersController=tslib_1.__decorate([(0,common_1.Controller)("user"),tslib_1.__metadata("design:paramtypes",["function"==typeof(_a=void 0!==users_service_1.UsersService&&users_service_1.UsersService)?_a:Object])],UsersController),exports.UsersController=UsersController},9568:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.UsersModule=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),mongoose_1=__webpack_require__(1794),environment_1=__webpack_require__(5070),communities_module_1=__webpack_require__(5467),neo4j_module_1=__webpack_require__(8558),user_schema_1=__webpack_require__(8366),users_controller_1=__webpack_require__(835),users_service_1=__webpack_require__(8223);let UsersModule=class UsersModule{};UsersModule=tslib_1.__decorate([(0,common_1.Module)({imports:[mongoose_1.MongooseModule.forFeature([{name:user_schema_1.User.name,schema:user_schema_1.UserSchema}]),(0,common_1.forwardRef)((()=>communities_module_1.CommunitiesModule)),neo4j_module_1.Neo4jModule.forRoot({scheme:"bolt",host:environment_1.environment.BASE_NEO_HOST,port:7687,username:"neo4j",password:"neo"})],controllers:[users_controller_1.UsersController],providers:[users_service_1.UsersService],exports:[users_service_1.UsersService]})],UsersModule),exports.UsersModule=UsersModule},8223:(__unused_webpack_module,exports,__webpack_require__)=>{var _a,_b,_c,_d;Object.defineProperty(exports,"__esModule",{value:!0}),exports.UsersService=void 0;const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),mongoose_1=__webpack_require__(1185),role_enum_1=__webpack_require__(4302),bcrypt=__webpack_require__(7096),user_schema_1=__webpack_require__(8366),mongoose_2=__webpack_require__(1794),communities_service_1=__webpack_require__(8345),community_schema_1=__webpack_require__(5811),neo4j_service_1=__webpack_require__(6397);let UsersService=class UsersService{constructor(userModel,communityModel,communitiesService,neo4jService){this.userModel=userModel,this.communityModel=communityModel,this.communitiesService=communitiesService,this.neo4jService=neo4jService}getUserByUsername(username){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return this.userModel.findOne({username})}))}getUsers(){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.userModel.aggregate([{$lookup:{from:"users",localField:"following",foreignField:"_id",as:"following"}},{$lookup:{from:"users",localField:"followers",foreignField:"_id",as:"followers"}},{$unset:["password","__v"]}])}))}getUserById(id){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.existing(id),(yield this.userModel.aggregate([{$match:{_id:new mongoose_1.Types.ObjectId(id)}},{$lookup:{from:"users",localField:"following",foreignField:"_id",as:"following"}},{$lookup:{from:"users",localField:"followers",foreignField:"_id",as:"followers"}},{$unset:["password","__v"]}]))[0]}))}addJoinedCommunity(communityId,userId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.existing(userId.toString()),yield this.userModel.findOneAndUpdate({_id:userId},{$push:{joinedCommunities:communityId}},{new:!0})}))}addCreatedCommunity(communityId,userId){var e_1,_a;return tslib_1.__awaiter(this,void 0,void 0,(function*(){yield this.existing(userId.toString());const user=yield this.userModel.findOne({_id:userId});try{for(var _c,_b=tslib_1.__asyncValues(user.createdCommunities);!(_c=yield _b.next()).done;){const createdCommunityId=_c.value;yield this.communityModel.updateMany({_id:new mongoose_1.Types.ObjectId(createdCommunityId),"owner._id":new mongoose_1.Types.ObjectId(userId)},{$push:{"owner.$[_id]createdCommunities":communityId}})}}catch(e_1_1){e_1={error:e_1_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&(yield _a.call(_b))}finally{if(e_1)throw e_1.error}}return yield this.userModel.findOneAndUpdate({_id:userId},{$push:{createdCommunities:communityId}},{new:!0})}))}removeJoinedCommunity(communityId,userId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){yield this.existing(userId.toString());return(yield this.communityModel.findOne({_id:communityId})).owner._id.equals(userId)&&(yield this.communityModel.updateMany({_id:communityId,"owner._id":userId},{$pull:{"owner.$.joinedCommunities":communityId}})),yield this.userModel.findOneAndUpdate({_id:userId},{$pull:{joinedCommunities:communityId}},{new:!0})}))}removeCreatedCommunity(communityId,userId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){return yield this.existing(userId.toString()),yield this.userModel.findOneAndUpdate({_id:userId},{$pull:{createdCommunities:communityId}},{new:!0})}))}followUser(req,id){return tslib_1.__awaiter(this,void 0,void 0,(function*(){yield this.existing(id);const user=yield this.getUserById(id);if((yield this.getUserById(req.user.id))._id.equals(user._id))throw new common_1.HttpException("Can not follow yourself!",common_1.HttpStatus.BAD_REQUEST);if((yield this.userModel.find({$and:[{_id:req.user.id},{following:{$in:new mongoose_1.Types.ObjectId(id)}}]})).length>0)throw new common_1.HttpException("Already following this user!",common_1.HttpStatus.BAD_REQUEST);{const resultUser=yield this.userModel.findOneAndUpdate({_id:new mongoose_1.Types.ObjectId(id)},{$push:{followers:new mongoose_1.Types.ObjectId(req.user.id)}},{new:!0});return[yield this.userModel.findOneAndUpdate({_id:new mongoose_1.Types.ObjectId(req.user.id)},{$push:{following:new mongoose_1.Types.ObjectId(id)}},{new:!0}),resultUser]}}))}unfollowUser(req,id){return tslib_1.__awaiter(this,void 0,void 0,(function*(){yield this.existing(id);const user=yield this.getUserById(id);if((yield this.getUserById(req.user.id))._id.equals(user._id))throw new common_1.HttpException("Can not unfollow yourself!",common_1.HttpStatus.BAD_REQUEST);if(0!==(yield this.userModel.find({$and:[{_id:req.user.id},{following:{$in:new mongoose_1.Types.ObjectId(id)}}]})).length){const resultUser=yield this.userModel.findOneAndUpdate({_id:new mongoose_1.Types.ObjectId(id)},{$pull:{followers:new mongoose_1.Types.ObjectId(req.user.id)}},{new:!0});return[yield this.userModel.findOneAndUpdate({_id:new mongoose_1.Types.ObjectId(req.user.id)},{$pull:{following:new mongoose_1.Types.ObjectId(id)}},{new:!0}),resultUser]}throw new common_1.HttpException("You do not follow this user!",common_1.HttpStatus.BAD_REQUEST)}))}createUser(username,birthDate,emailAddress,phoneNumber,password,image){return tslib_1.__awaiter(this,void 0,void 0,(function*(){if(password=yield bcrypt.hashSync(password,10),(birthDate=new Date(birthDate)).setHours(birthDate.getHours()+1),birthDate>new Date)throw new common_1.HttpException(`Birthdate ${birthDate} lies in the future!`,common_1.HttpStatus.BAD_REQUEST);if((yield this.getUsers()).filter((p=>p.username===username)).length>0)throw new common_1.HttpException(`Username ${username} already in use!`,common_1.HttpStatus.BAD_REQUEST);const newUser=new this.userModel({_id:new mongoose_1.Types.ObjectId,username,birthDate,emailAddress,phoneNumber,password,registerDate:new Date,image,roles:[role_enum_1.Role.User],isActive:!0}),result=yield this.userModel.create(newUser);return yield this.neo4jService.write(`\n      CREATE\n      (n:User {\n      id: '${result._id.toString()}',\n      username: '${newUser.username}', \n      birthDate: '${newUser.birthDate.toISOString()}'\n     })`,{}),result}))}updateUser(req,id,user){return tslib_1.__awaiter(this,void 0,void 0,(function*(){if(yield this.existing(id),req.user.id.equals(new mongoose_1.Types.ObjectId(id))||req.user.roles.includes(role_enum_1.Role.Admin)){if(user.username&&(yield this.getUsers()).filter((p=>p.username===user.username&&!p._id.equals(new mongoose_1.Types.ObjectId(id)))).length>0)throw new common_1.HttpException(`Username ${user.username} already in use!`,common_1.HttpStatus.BAD_REQUEST);if(user.birthDate&&(user.birthDate=new Date(user.birthDate),user.birthDate.setHours(user.birthDate.getHours()+1),user.birthDate>new Date))throw new common_1.HttpException(`Birthdate ${user.birthDate} lies in the future!`,common_1.HttpStatus.BAD_REQUEST);user.password&&(user.password=yield bcrypt.hashSync(user.password,10)),user._id=new mongoose_1.Types.ObjectId(id);return(yield this.communitiesService.getCommunities()).filter((p=>p.owner._id.equals(user._id))).forEach((comm=>tslib_1.__awaiter(this,void 0,void 0,(function*(){yield this.communityModel.updateOne({_id:new mongoose_1.Types.ObjectId(comm._id)},{$set:{owner:Object.assign(Object.assign({},yield this.getUserById(id)),user)}})})))),this.userModel.findOneAndUpdate({_id:new mongoose_1.Types.ObjectId(id)},user)}throw new common_1.HttpException("Unauthorized",common_1.HttpStatus.UNAUTHORIZED)}))}existing(userId){return tslib_1.__awaiter(this,void 0,void 0,(function*(){if(!(yield this.userModel.findOne({_id:new mongoose_1.Types.ObjectId(userId)})))throw new common_1.HttpException(`User with id ${userId} does not exist!`,common_1.HttpStatus.BAD_REQUEST)}))}};UsersService=tslib_1.__decorate([(0,common_1.Injectable)(),tslib_1.__param(0,(0,mongoose_2.InjectModel)(user_schema_1.User.name)),tslib_1.__param(1,(0,mongoose_2.InjectModel)(community_schema_1.Community.name)),tslib_1.__param(2,(0,common_1.Inject)((0,common_1.forwardRef)((()=>communities_service_1.CommunitiesService)))),tslib_1.__metadata("design:paramtypes",["function"==typeof(_a=void 0!==mongoose_1.Model&&mongoose_1.Model)?_a:Object,"function"==typeof(_b=void 0!==mongoose_1.Model&&mongoose_1.Model)?_b:Object,"function"==typeof(_c=void 0!==communities_service_1.CommunitiesService&&communities_service_1.CommunitiesService)?_c:Object,"function"==typeof(_d=void 0!==neo4j_service_1.Neo4jService&&neo4j_service_1.Neo4jService)?_d:Object])],UsersService),exports.UsersService=UsersService},5070:(__unused_webpack_module,exports)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.environment=void 0;const password=process.env.PASSWORD_MONGO_URL,usernameNeo=process.env.USERNAME_NEO,passwordNeo=process.env.PASSWORD_NEO;exports.environment={production:!0,BASE_MONGO_URL:`mongodb://Gustave:${password}@ac-ldb5hca-shard-00-00.m6gvewv.mongodb.net:27017,ac-ldb5hca-shard-00-01.m6gvewv.mongodb.net:27017,ac-ldb5hca-shard-00-02.m6gvewv.mongodb.net:27017/?ssl=true&replicaSet=atlas-jaynf6-shard-0&authSource=admin&retryWrites=true&w=majority`,BASE_NEO_HOST:"44.199.235.138",USERNAME_NEO:usernameNeo,PASSWORD_NEO:passwordNeo}},6481:module=>{module.exports=require("@nestjs/common")},143:module=>{module.exports=require("@nestjs/core")},2064:module=>{module.exports=require("@nestjs/jwt")},1794:module=>{module.exports=require("@nestjs/mongoose")},4340:module=>{module.exports=require("@nestjs/passport")},7096:module=>{module.exports=require("bcrypt")},5849:module=>{module.exports=require("class-validator")},1185:module=>{module.exports=require("mongoose")},3255:module=>{module.exports=require("neo4j-driver")},136:module=>{module.exports=require("passport-jwt")},7055:module=>{module.exports=require("passport-local")},752:module=>{module.exports=require("tslib")}},__webpack_module_cache__={};function __webpack_require__(moduleId){var cachedModule=__webpack_module_cache__[moduleId];if(void 0!==cachedModule)return cachedModule.exports;var module=__webpack_module_cache__[moduleId]={exports:{}};return __webpack_modules__[moduleId](module,module.exports,__webpack_require__),module.exports}var __webpack_exports__={};(()=>{var exports=__webpack_exports__;Object.defineProperty(exports,"__esModule",{value:!0});const tslib_1=__webpack_require__(752),common_1=__webpack_require__(6481),core_1=__webpack_require__(143),app_module_1=__webpack_require__(3029),validation_filter_1=__webpack_require__(9764),validation_exception_1=__webpack_require__(2046);!function(){tslib_1.__awaiter(this,void 0,void 0,(function*(){const app=yield core_1.NestFactory.create(app_module_1.AppModule);app.enableCors(),app.useGlobalFilters(new validation_filter_1.ValidationFilter),app.setGlobalPrefix("api"),app.useGlobalPipes(new common_1.ValidationPipe({exceptionFactory:errors=>{const messages=errors.map((error=>`${error.property} has wrong value ${error.value}, ${Object.values(error.constraints).join(", ")}`));return new validation_exception_1.ValidationException(messages)}}));const port=process.env.PORT||3333;yield app.listen(port),common_1.Logger.log(`🚀 Application is running on: http://localhost:${port}/api`)}))}()})();var __webpack_export_target__=exports;for(var i in __webpack_exports__)__webpack_export_target__[i]=__webpack_exports__[i];__webpack_exports__.__esModule&&Object.defineProperty(__webpack_export_target__,"__esModule",{value:!0})})();
//# sourceMappingURL=main.js.map